name: CI

on:
  push:
    branches: ['main']
    tags: ['**']
  pull_request:
    branches: ['**']

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libudev-dev libgtk-3-dev grep llvm clang libclang-dev libsdl2-dev libsdl2-gfx-dev
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: rustfmt
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            target/debug/build/
            target/debug/deps/
            target/debug/.fingerprint/
            target/debug/.cargo-lock
            target/release/build/
            target/release/deps/
            target/release/.fingerprint/
            target/release/.cargo-lock
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-
      
      - name: Check formatting
        run: cargo fmt --check

  check:
    name: Lint and Check
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libudev-dev libgtk-3-dev grep llvm clang libclang-dev libsdl2-dev libsdl2-gfx-dev
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            target/debug/build/
            target/debug/deps/
            target/debug/.fingerprint/
            target/debug/.cargo-lock
            target/release/build/
            target/release/deps/
            target/release/.fingerprint/
            target/release/.cargo-lock
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-
      
      - name: Install clippy
        run: rustup component add clippy
      
      - name: Run cargo check
        run: cargo check
      
      - name: Install cargo-cranky
        run: cargo install cargo-cranky
      
      - name: Run cargo cranky
        run: cargo cranky

  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libudev-dev libgtk-3-dev grep llvm clang libclang-dev libsdl2-dev libsdl2-gfx-dev
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            target/debug/build/
            target/debug/deps/
            target/debug/.fingerprint/
            target/debug/.cargo-lock
            target/release/build/
            target/release/deps/
            target/release/.fingerprint/
            target/release/.cargo-lock
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-
      
      - name: Create git hooks directory
        run: mkdir -p .git/hooks || true
      
      - name: Run tests
        run: cargo test --all -- --test-threads=1

  release:
    name: Release Build
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libudev-dev libgtk-3-dev grep llvm clang libclang-dev libsdl2-dev libsdl2-gfx-dev
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            target/debug/build/
            target/debug/deps/
            target/debug/.fingerprint/
            target/debug/.cargo-lock
            target/release/build/
            target/release/deps/
            target/release/.fingerprint/
            target/release/.cargo-lock
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-
      
      - name: Install cargo-vendor-filterer
        run: cargo install cargo-vendor-filterer
      
      - name: Build and vendor
        run: |
          make
          make vendor
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            vendor_asusctl*.tar.xz
            cargo-config
          retention-days: 30
